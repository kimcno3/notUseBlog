---
published: true
layout: post
title: "[football] Scale Out을 고려한 아키텍처 설계"
author: kimcno3
categories: f-lab
tags:  f-lab project2
---

## # 문제점
애플리케이션이 실제 배포가 되었을 때, 사용자 수가 증가함에 따라 트래픽이 증가할수록 서버를 확장해야 하는데 SPOF로 인해 확장이 불가능해 심각한 장애를 발생시킬 수 있다고 생각했습니다. 그래서 아키텍처 설계 단계에서부터 Scale Out이 가능한 아키텍처 설계를 고민해보고 구성해보기로 결정했습니다. 

## # 해결방안
### 1. API 서버와 채팅서버를 분리
채팅기능 구현을 위해선 STOMP나 Redis pub/sub과 같은 메세징 기법을 활용해볼 수도 있지만 두 기술을 결국 외부 브로커에게 의존하는 형태로 동작하고 외부 브로커에 채널이나 큐가 추가되면 과부화가 올 수 있습니다. 또한 외부 브로커를 사용하는 것은 **SPOF 문제가 발생할 수 있는 지점**이라 판단해 웹소켓을 직접 활용하는 방향으로 설계하기로 했습니다.

그래서 사용자 요청을 처리하기 위해 직접 접근해야 하는 API 서버와 웹소켓 연결을 위해 동일하게 사용자의 요청을 처리해야하는 채팅 서버를 분리하고, 두 서버의 역할을 명확하게 구분하는 것과 동시에 서버 확장에도 용이한 구조로 설계했습니다.

### 2. Health Check
API 서버와 채팅 서버를 구분한 구조에서 API 서버 입장에선 메세지를 받아야 하는 사용자가 접속한 채팅 서버 주소를 알아야 합니다. 그래서 채팅 서버에서 지속적으로 서버 상태에 대한 데이터를 API 서버에 보내면 API 서버는 채팅 서버의 상태 정보를 저장하도록 구성했습니다.

그리고 웹소켓 접속 요청을 받으면 최적의 채팅 서버 주소를 리턴해주면서 트래픽 과부화에 대한 위험도 낮추도록 구성했습니다.

### 3. Redis Cluster
채팅 서버에 대한 Health Check 정보를 저장하기 위해서 Redis를 선택했습니다. 지속적으로 데이터가 저장 및 수정, 조회가 되어야 하는 특성을 고려해 빠른 저장 및 조회가 가능하기에 Redis를 선택한 것도 있지만 Redis Cluster 모드를 통해 SPOF를 해결할 수도 있기 때문이였습니다.

Redis Cluster 모드를 통해 하나의 서버에 모든 데이터를 저장하지 않고 분산 저장함으로써 데이터 분실에 대한 위험도를 낮출 수 있었습니다.

### 4. 설계된 아키텍처 도안
위에 작성한 문제가 될 수 있는 지점들을 고려해 작성한 아키텍처 도안은 다음과 같습니다.

![](https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc85a877e-0c52-46c1-8f05-2db2a4db3104%2Farchitecture.drawio.png?table=block&id=dad3c153-f821-402a-a19c-ded9cec0e9a3&spaceId=74818e1f-1cd4-4adc-ae94-8afb88b31553&width=2000&userId=2f0da12b-1a66-4b50-bcbe-b24c58210e93&cache=v2)

> 실제로 FCM은 직접 구현하지 않고 log를 통해 비동기 식으로 처리되는 구조로만 구현했습니다.

## # 마치며
이처럼 아키텍처 설계 단계에서부터 확장 가능성을 고려해봄으로써 트래픽 과부하, 서버 다운 등의 문제를 해결할 수 있는 최적의 설계를 구현하기 위한 깊은 고민을 해볼 수 있었습니다.